<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Namens-Knockout</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <style>
    html {
      font-size: 16px;
    }
    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      -webkit-tap-highlight-color: transparent;
    }
    body {
      margin: 0;
      padding: 20px;
      background: #f5f5f7;
      color: #111827;
      display: flex;
      justify-content: center;
    }
    .app {
      max-width: 900px;
      width: 100%;
      background: #ffffff;
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.06);
    }
    h1 {
      margin-top: 0;
      font-size: 1.5rem;
      text-align: center;
    }
    .intro {
      font-size: 0.9rem;
      color: #4b5563;
      margin-bottom: 8px;
      text-align: center;
    }
    .hint {
      font-size: 0.8rem;
      color: #6b7280;
      margin-bottom: 16px;
      text-align: center;
    }
    textarea {
      width: 100%;
      border-radius: 10px;
      border: 1px solid #d1d5db;
      padding: 12px;
      min-height: 140px;
      resize: vertical;
      font-size: 1rem;
    }

    /* Setup-Bereich (Namen + Buttons) */
    #setupSection {
      transition: max-height 0.25s ease, padding 0.25s ease, margin 0.25s ease;
    }

    .controls {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 12px;
      align-items: center;
      text-align: center;
    }

    .btn-main-wrapper {
      display: flex;
      justify-content: center;
      width: 100%;
    }

    .btn-start-main {
      min-width: 220px;
      padding: 12px 28px;
      font-size: 1rem; /* >= 16px gegen Zoom */
    }

    .btn-group {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      justify-content: center;
    }

    button {
      border: none;
      border-radius: 999px;
      padding: 10px 18px;
      font-size: 1rem; /* wichtig für Mobile */
      cursor: pointer;
      transition: transform 0.05s ease, box-shadow 0.05s ease, background-color 0.1s ease;
    }
    button:active {
      transform: translateY(1px);
      box-shadow: none;
    }
    .btn-primary {
      background: #111827;
      color: #ffffff;
      box-shadow: 0 6px 16px rgba(0,0,0,0.15);
    }
    .btn-secondary {
      background: #e5e7eb;
      color: #111827;
    }
    .btn-outline {
      background: #ffffff;
      border: 1px solid #d1d5db;
      color: #111827;
    }
    .status {
      font-size: 0.8rem;
      color: #6b7280;
      margin-top: 4px;
    }
    .error {
      color: #b91c1c;
      font-size: 0.8rem;
      margin-top: 6px;
      text-align: center;
    }
    .share {
      margin-top: 12px;
      font-size: 0.8rem;
    }
    .share-label, .result-label {
      font-weight: 500;
      margin-bottom: 4px;
      display: block;
    }
    .share-input, .result-input {
      width: 100%;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      padding: 8px 12px;
      font-size: 0.9rem;
      background: #f9fafb;
    }
    .share-note, .result-note {
      font-size: 0.75rem;
      color: #6b7280;
      margin-top: 4px;
    }
    .copy-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 8px;
    }
    .copy-buttons button {
      font-size: 0.8rem;
      padding: 8px 14px;
    }

    .match-section {
      margin-top: 24px;
      border-top: 1px solid #e5e7eb;
      padding-top: 20px;
    }
    .round-info {
      font-size: 0.8rem;
      color: #4b5563;
      margin-bottom: 12px;
      display: flex;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 6px;
    }
    .cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 16px;
    }
    .card {
      border-radius: 14px;
      padding: 18px;
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      min-height: 110px;
    }
    .card-title {
      font-size: 1.1rem;
      font-weight: 600;
      word-break: break-word;
      margin-bottom: 10px;
    }
    .card-sub {
      font-size: 0.8rem;
      color: #6b7280;
      margin-bottom: 10px;
    }
    .card button {
      align-self: flex-start;
      margin-top: auto;
    }
    .winner {
      margin-top: 24px;
      padding: 24px;
      background: #ecfdf5;
      border: 1px solid #6ee7b7;
      border-radius: 16px;
      text-align: center;
    }
    .winner-title {
      font-size: 0.9rem;
      color: #047857;
      margin-bottom: 6px;
    }
    .winner-name {
      font-size: 1.5rem;
      font-weight: 700;
      color: #065f46;
      word-break: break-word;
    }
    .result-share {
      margin-top: 16px;
      text-align: left;
    }
    .top3 {
      margin-top: 16px;
      text-align: left;
    }
    .top3-title {
      font-size: 0.85rem;
      font-weight: 600;
      color: #047857;
      margin-bottom: 4px;
    }
    .top3-list {
      margin: 0 0 0 20px;
      padding: 0;
      font-size: 0.85rem;
      color: #065f46;
    }
    .top3-list li {
      margin: 1px 0;
      word-break: break-word;
    }
    details {
      margin-top: 16px;
      font-size: 0.85rem;
    }
    details summary {
      cursor: pointer;
      font-weight: 500;
      margin-bottom: 6px;
    }
    .name-list {
      list-style: decimal;
      margin: 4px 0 0 18px;
      padding: 0;
    }
    .name-list li {
      margin: 2px 0;
      word-break: break-word;
    }

    /* Mobile-Optimierung */
    @media (max-width: 600px) {
      body {
        padding: 10px;
      }
      .app {
        padding: 14px;
      }
      /* Setup-Bereich auf Mobile einklappen, wenn Klasse gesetzt */
      .collapsed-on-mobile {
        max-height: 0;
        overflow: hidden;
        padding-top: 0 !important;
        padding-bottom: 0 !important;
        margin-bottom: 0 !important;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <h1>Namens-Knockout</h1>
    <p class="intro">
      Füge eure Namensideen ein und spiele sie in Knockout-Runden gegeneinander aus,
      bis ein Gewinner übrig bleibt.
    </p>
    <p class="hint">
      Du kannst Namen mit Zeilenumbrüchen, Kommas, Semikolons oder Bullet-Points einfügen –
      die App trennt sie automatisch. Mit dem generierten Link können andere die gleiche Liste benutzen.
    </p>

    <!-- SETUP-BEREICH -->
    <div id="setupSection">
      <label for="namesInput" style="font-size:0.8rem;font-weight:500;margin-bottom:4px;display:block;">
        Namensliste (einfach reinkopieren)
      </label>
      <textarea id="namesInput" placeholder="Beispiele:
NeoBite, FrostLane, Panomix; ArcticFlow
• FrigoSprint
• PolarWorks
..."></textarea>

      <div class="controls">
        <!-- isolierter, mittiger Start-Button -->
        <div class="btn-main-wrapper">
          <button id="startBtn" class="btn-primary btn-start-main">Turnier starten</button>
        </div>

        <!-- sekundäre Buttons darunter -->
        <div class="btn-group">
          <button id="shareBtn" class="btn-outline">Link generieren</button>
          <button id="listBtn" class="btn-outline">Namensliste</button>
          <button id="resetBtn" class="btn-secondary">Zurücksetzen</button>
        </div>

        <span id="status" class="status"></span>
      </div>
      <div id="error" class="error"></div>

      <div id="shareContainer" class="share" style="display:none;">
        <span class="share-label">Teilbaren Link kopieren:</span>
        <input id="shareLink" class="share-input" type="text" readonly />
        <div class="copy-buttons">
          <button id="copyShareBtn" class="btn-outline">Link kopieren</button>
        </div>
        <div class="share-note">Diesen Link an andere schicken – sie sehen dieselbe Namensliste und können eigene Knockout-Runden starten.</div>
      </div>

      <details id="allNamesDetails">
        <summary>Alle Namen anzeigen / verstecken</summary>
        <ol id="nameList" class="name-list"></ol>
      </details>
    </div>

    <!-- TURNIER-BEREICH -->
    <div id="matchSection" class="match-section" style="display:none;">
      <div class="round-info">
        <span id="roundInfo"></span>
        <span id="matchInfo"></span>
      </div>
      <div class="cards">
        <div class="card" id="cardA" style="display:none;">
          <div class="card-title" id="nameA"></div>
          <div class="card-sub">Klicke, wenn dieser Name weiterkommen soll.</div>
          <button class="btn-primary" id="btnA">Diesen Namen wählen</button>
        </div>
        <div class="card" id="cardB" style="display:none;">
          <div class="card-title" id="nameB"></div>
          <div class="card-sub">Klicke, wenn dieser Name weiterkommen soll.</div>
          <button class="btn-primary" id="btnB">Diesen Namen wählen</button>
        </div>
      </div>
    </div>

    <div id="winnerSection" style="display:none;"></div>
  </div>

  <script>
    const namesInput = document.getElementById('namesInput');
    const startBtn = document.getElementById('startBtn');
    const resetBtn = document.getElementById('resetBtn');
    const shareBtn = document.getElementById('shareBtn');
    const listBtn = document.getElementById('listBtn');
    const statusEl = document.getElementById('status');
    const errorEl = document.getElementById('error');
    const matchSection = document.getElementById('matchSection');
    const roundInfoEl = document.getElementById('roundInfo');
    const matchInfoEl = document.getElementById('matchInfo');
    const cardA = document.getElementById('cardA');
    const cardB = document.getElementById('cardB');
    const nameAEl = document.getElementById('nameA');
    const nameBEl = document.getElementById('nameB');
    const btnA = document.getElementById('btnA');
    const btnB = document.getElementById('btnB');
    const winnerSection = document.getElementById('winnerSection');
    const nameList = document.getElementById('nameList');
    const shareContainer = document.getElementById('shareContainer');
    const shareLinkInput = document.getElementById('shareLink');
    const copyShareBtn = document.getElementById('copyShareBtn');
    const allNamesDetails = document.getElementById('allNamesDetails');
    const setupSection = document.getElementById('setupSection');

    let originalNames = [];
    let currentRound = [];
    let winners = [];
    let currentIndex = 0;
    let roundNumber = 1;
    let matchCount = 0;
    let matchesThisRound = 0;
    let stats = {}; // pro Name: { eliminatedRound: number }

    function shuffle(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
      return array;
    }

    function updateNameList() {
      nameList.innerHTML = '';
      originalNames.forEach((n) => {
        const li = document.createElement('li');
        li.textContent = n;
        nameList.appendChild(li);
      });
    }

    function parseNames() {
      const raw = namesInput.value
        .split(/[\n,;•·\t]+/g)
        .map((x) => x.trim())
        .filter((x) => x.length > 0);
      return raw;
    }

    function resetTournament(full = true) {
      currentRound = [];
      winners = [];
      currentIndex = 0;
      roundNumber = 1;
      matchCount = 0;
      matchesThisRound = 0;
      stats = {};
      matchSection.style.display = 'none';
      winnerSection.style.display = 'none';
      winnerSection.innerHTML = '';
      setupSection.classList.remove('collapsed-on-mobile');
      if (full) {
        statusEl.textContent = '';
        shareContainer.style.display = 'none';
        shareLinkInput.value = '';
      }
      errorEl.textContent = '';
      cardA.style.display = 'none';
      cardB.style.display = 'none';
      roundInfoEl.textContent = '';
      matchInfoEl.textContent = '';
    }

    function startTournament() {
      resetTournament(false);
      const names = parseNames();
      if (names.length < 2) {
        errorEl.textContent = 'Bitte gib mindestens 2 Namen ein.';
        return;
      }
      errorEl.textContent = '';
      originalNames = names;
      stats = {};
      originalNames.forEach((n) => {
        stats[n] = { eliminatedRound: null };
      });
      updateNameList();
      currentRound = shuffle([...originalNames]);
      roundNumber = 1;
      statusEl.textContent = `Turnier gestartet mit ${currentRound.length} Namen.`;

      if (window.innerWidth <= 600) {
        setupSection.classList.add('collapsed-on-mobile');
      }

      prepareRound();
      matchSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    function prepareRound() {
      winners = [];
      currentIndex = 0;
      matchCount = 0;
      matchesThisRound = Math.floor(currentRound.length / 2);
      matchSection.style.display = 'block';
      winnerSection.style.display = 'none';
      roundInfoEl.textContent = `Runde ${roundNumber} – ${currentRound.length} Namen`;
      showNextMatch();
    }

    function showNextMatch() {
      if (currentIndex === currentRound.length - 1) {
        winners.push(currentRound[currentIndex]);
        currentIndex++;
      }

      if (currentIndex >= currentRound.length) {
        if (winners.length === 1) {
          showWinner(winners[0]);
        } else {
          currentRound = winners;
          roundNumber++;
          prepareRound();
        }
        return;
      }

      const nameA = currentRound[currentIndex];
      const nameB = currentRound[currentIndex + 1];

      nameAEl.textContent = nameA;
      nameBEl.textContent = nameB;
      cardA.style.display = 'flex';
      cardB.style.display = 'flex';
      matchCount++;
      matchInfoEl.textContent = `Duell ${matchCount} von ${matchesThisRound === 0 ? 1 : matchesThisRound}`;
    }

    function chooseWinner(winnerName) {
      const nameA = nameAEl.textContent;
      const nameB = nameBEl.textContent;
      const loserName = winnerName === nameA ? nameB : nameA;
      if (stats[loserName]) {
        stats[loserName].eliminatedRound = roundNumber;
      }

      winners.push(winnerName);
      currentIndex += 2;
      showNextMatch();
    }

    function computeTop3(finalWinner) {
      if (stats[finalWinner]) {
        stats[finalWinner].eliminatedRound = roundNumber + 1;
      }
      const ranked = [...originalNames].sort((a, b) => {
        const ra = stats[a]?.eliminatedRound ?? 0;
        const rb = stats[b]?.eliminatedRound ?? 0;
        return rb - ra;
      });
      return ranked.slice(0, 3);
    }

    function renderTop3(listElement, top3Array, winnerName) {
      listElement.innerHTML = '';
      if (!top3Array || top3Array.length === 0) return;
      top3Array.forEach((n, idx) => {
        const li = document.createElement('li');
        let label = n;
        if (idx === 0 && n === winnerName) {
          label = `${n} (1. Platz)`;
        } else if (idx === 1) {
          label = `${n} (2. Platz)`;
        } else if (idx === 2) {
          label = `${n} (3. Platz)`;
        }
        li.textContent = label;
        listElement.appendChild(li);
      });
    }

    function attachCopyAndShareHandlers(inputElement, url) {
      const copyBtn = winnerSection.querySelector('#copyResultBtn');
      const shareBtn = winnerSection.querySelector('#shareResultBtn');

      if (copyBtn) {
        copyBtn.addEventListener('click', () => {
          inputElement.select();
          document.execCommand('copy');
          copyBtn.textContent = 'Kopiert ✔';
          setTimeout(() => (copyBtn.textContent = 'Link kopieren'), 1500);
        });
      }

      if (shareBtn) {
        if (navigator.share) {
          shareBtn.addEventListener('click', async () => {
            try {
              await navigator.share({
                title: 'Namens-Knockout Ergebnis',
                text: 'Schau dir unser Ergebnis (Gewinner + Top 3) an:',
                url
              });
            } catch (e) {
              console.log('Teilen abgebrochen oder nicht möglich', e);
            }
          });
        } else {
          shareBtn.disabled = true;
          shareBtn.textContent = 'Teilen nicht verfügbar';
        }
      }
    }

    function showWinner(name) {
      matchSection.style.display = 'none';
      winnerSection.style.display = 'block';

      const top3 = computeTop3(name);

      const jsonNames = JSON.stringify(originalNames);
      const encodedNames = encodeURIComponent(jsonNames);
      const jsonTop3 = JSON.stringify(top3);
      const encodedTop3 = encodeURIComponent(jsonTop3);
      const baseUrl = window.location.origin + window.location.pathname;
      const resultUrl = `${baseUrl}?data=${encodedNames}&winner=${encodeURIComponent(name)}&top3=${encodedTop3}`;

      winnerSection.innerHTML = `
        <div class="winner">
          <div class="winner-title">Gewinner-Name</div>
          <div class="winner-name"></div>
          <div class="top3">
            <div class="top3-title">Top 3</div>
            <ol class="top3-list"></ol>
          </div>
          <div class="result-share">
            <div class="result-label">Ergebnis-Link (inkl. Top 3):</div>
            <input class="result-input" type="text" readonly />
            <div class="copy-buttons">
              <button id="copyResultBtn" class="btn-outline">Link kopieren</button>
              <button id="shareResultBtn" class="btn-primary">Teilen</button>
            </div>
            <div class="result-note">Diesen Link kannst du speichern oder weitergeben, um dieses Ergebnis zu zeigen.</div>
          </div>
        </div>
      `;
      const nameEl = winnerSection.querySelector('.winner-name');
      const input = winnerSection.querySelector('.result-input');
      const top3ListEl = winnerSection.querySelector('.top3-list');
      nameEl.textContent = name;
      input.value = resultUrl;
      renderTop3(top3ListEl, top3, name);

      attachCopyAndShareHandlers(input, resultUrl);

      statusEl.textContent = 'Turnier beendet.';
      winnerSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    function generateShareLink() {
      const names = parseNames();
      if (names.length < 2) {
        errorEl.textContent = 'Für einen Link brauchst du mindestens 2 Namen.';
        return;
      }
      errorEl.textContent = '';
      originalNames = names;
      stats = {};
      originalNames.forEach((n) => {
        stats[n] = { eliminatedRound: null };
      });
      updateNameList();

      const json = JSON.stringify(names);
      const encoded = encodeURIComponent(json);
      const baseUrl = window.location.origin + window.location.pathname;
      const url = `${baseUrl}?data=${encoded}`;

      shareContainer.style.display = 'block';
      shareLinkInput.value = url;
      statusEl.textContent = `Link generiert für ${names.length} Namen.`;
    }

    function loadFromUrl() {
      const params = new URLSearchParams(window.location.search);
      const dataParam = params.get('data');
      const winnerParam = params.get('winner');
      const top3Param = params.get('top3');

      if (dataParam) {
        try {
          const json = decodeURIComponent(dataParam);
          const arr = JSON.parse(json);
          if (Array.isArray(arr) && arr.length > 0) {
            originalNames = arr.map((x) => String(x)).filter((x) => x.trim().length > 0);
            stats = {};
            originalNames.forEach((n) => {
              stats[n] = { eliminatedRound: null };
            });
            namesInput.value = originalNames.join('\n');
            updateNameList();
            statusEl.textContent = `Namensliste aus geteilter URL geladen (${originalNames.length} Namen).`;
          }
        } catch (e) {
          console.error('Fehler beim Laden der Daten aus URL', e);
        }
      }

      if (winnerParam) {
        const winnerName = winnerParam;
        let top3 = null;
        if (top3Param) {
          try {
            const tjson = decodeURIComponent(top3Param);
            const tarr = JSON.parse(tjson);
            if (Array.isArray(tarr)) {
              top3 = tarr;
            }
          } catch (e) {
            console.error('Fehler beim Laden der Top 3 aus URL', e);
          }
        }

        winnerSection.style.display = 'block';
        const jsonNames = JSON.stringify(originalNames.length ? originalNames : [winnerName]);
        const encodedNames = encodeURIComponent(jsonNames);
        const jsonTop3 = JSON.stringify(top3 || []);
        const encodedTop3 = encodeURIComponent(jsonTop3);
        const baseUrl = window.location.origin + window.location.pathname;
        const resultUrl = `${baseUrl}?data=${encodedNames}&winner=${encodeURIComponent(winnerName)}&top3=${encodedTop3}`;

        winnerSection.innerHTML = `
          <div class="winner">
            <div class="winner-title">Gespeicherter Gewinner-Name</div>
            <div class="winner-name"></div>
            <div class="top3">
              <div class="top3-title">Top 3</div>
              <ol class="top3-list"></ol>
            </div>
            <div class="result-share">
              <div class="result-label">Ergebnis-Link:</div>
              <input class="result-input" type="text" readonly />
              <div class="copy-buttons">
                <button id="copyResultBtn" class="btn-outline">Link kopieren</button>
                <button id="shareResultBtn" class="btn-primary">Teilen</button>
              </div>
              <div class="result-note">Dies ist ein gespeichertes Ergebnis aus einem früheren Lauf.</div>
            </div>
          </div>
        `;
        const nameEl = winnerSection.querySelector('.winner-name');
        const input = winnerSection.querySelector('.result-input');
        const top3ListEl = winnerSection.querySelector('.top3-list');
        nameEl.textContent = winnerName;
        input.value = resultUrl;
        if (top3 && top3.length) {
          renderTop3(top3ListEl, top3, winnerName);
        }
        attachCopyAndShareHandlers(input, resultUrl);

        statusEl.textContent = statusEl.textContent
          ? statusEl.textContent + ' | gespeichertes Ergebnis geladen.'
          : 'Gespeichertes Ergebnis geladen.';
      }
    }

    startBtn.addEventListener('click', startTournament);
    resetBtn.addEventListener('click', () => {
      resetTournament(true);
      namesInput.value = '';
      originalNames = [];
      updateNameList();
      if (window.location.search) {
        window.history.replaceState({}, document.title, window.location.pathname);
      }
    });
    btnA.addEventListener('click', () => chooseWinner(nameAEl.textContent));
    btnB.addEventListener('click', () => chooseWinner(nameBEl.textContent));
    shareBtn.addEventListener('click', generateShareLink);

    listBtn.addEventListener('click', () => {
      allNamesDetails.open = !allNamesDetails.open;
      allNamesDetails.scrollIntoView({ behavior: 'smooth', block: 'start' });
    });

    copyShareBtn.addEventListener('click', () => {
      if (!shareLinkInput.value) return;
      shareLinkInput.select();
      document.execCommand('copy');
      copyShareBtn.textContent = 'Kopiert ✔';
      setTimeout(() => (copyShareBtn.textContent = 'Link kopieren'), 1500);
    });

    loadFromUrl();
  </script>
</body>
</html>
